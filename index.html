<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seoul Travel Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Panzoom Library -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #111; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .font-cute { font-family: 'Fredoka', 'Noto Sans TC', sans-serif; }
        
        /* App 容器 */
        #app-container { 
            max-width: 480px; 
            height: 100dvh; 
            margin: 0 auto; 
            background-color: #fff; 
            position: relative; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        /* Pin Styles */
        .pin-marker { position: absolute; transform: translate(-50%, -100%); cursor: pointer; z-index: 10; display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        .pin-icon-box { width: 44px; height: 44px; background: white; border-radius: 50%; border: 3px solid white; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .pin-icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .pin-tail { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid white; margin-top: -2px; filter: drop-shadow(0 2px 1px rgba(0,0,0,0.1)); }
        .pin-label { background: rgba(255,255,255,0.95); padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; color: #4B5563; margin-top: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; }
        
        /* Theme Colors */
        .pin-theme-pink .pin-icon-box { border-color: #FCE7F3; background: #FCE7F3; color: #EC4899; } .pin-theme-pink .pin-tail { border-top-color: #FCE7F3; }
        .pin-theme-blue .pin-icon-box { border-color: #DBEAFE; background: #DBEAFE; color: #3B82F6; } .pin-theme-blue .pin-tail { border-top-color: #DBEAFE; }
        .pin-theme-green .pin-icon-box { border-color: #D1FAE5; background: #D1FAE5; color: #10B981; } .pin-theme-green .pin-tail { border-top-color: #D1FAE5; }
        .pin-theme-yellow .pin-icon-box { border-color: #FEF3C7; background: #FEF3C7; color: #F59E0B; } .pin-theme-yellow .pin-tail { border-top-color: #FEF3C7; }
        .pin-theme-purple .pin-icon-box { border-color: #EDE9FE; background: #EDE9FE; color: #8B5CF6; } .pin-theme-purple .pin-tail { border-top-color: #EDE9FE; }

        @keyframes bounce-soft { 0%, 100% { transform: translate(-50%, -100%); } 50% { transform: translate(-50%, -108%); } }
        .animate-bounce-soft { animation: bounce-soft 2s infinite ease-in-out; }

        /* 拖曳時的 Ghost Pin 動畫 */
        .ghost-pin { opacity: 0.8; z-index: 50; pointer-events: none; transform: translate(-50%, -120%) scale(1.1); transition: transform 0.1s; }
        
        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.9); }
    </style>
</head>
<body>
<div id="app">
    <div id="app-container">
        
        <!-- UI Layer -->
        
        <!-- 新增按鈕 (左上角) -->
        <button class="fixed top-4 left-4 z-50 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transform transition-all duration-300"
                :class="isAddingMode ? 'bg-gray-800 text-white rotate-45 scale-110' : 'bg-white/90 backdrop-blur text-pink-500 hover:scale-105 active:scale-95'"
                :style="{ maxWidth: '480px' }" 
                @click.stop="toggleAddMode">
            <i class="fas fa-plus text-xl"></i>
        </button>

        <!-- 新增模式提示 -->
        <div v-if="isAddingMode" class="fixed top-5 left-20 z-50 bg-gray-800/90 backdrop-blur text-white px-4 py-1.5 rounded-full shadow-xl text-xs font-bold flex items-center gap-2 animate-bounce w-max pointer-events-none">
            <i class="fas fa-fingerprint text-yellow-400"></i> <span>長按 0.2秒 拖曳新增</span>
        </div>

        <!-- Map Layer -->
        <div class="relative w-full h-full bg-white overflow-hidden" id="scene-container">
            
            <div id="panzoom-area" class="w-full flex flex-col origin-top-left bg-white min-h-full">
                
                <div id="map-content" 
                     class="relative w-full pb-20 select-none"
                     :class="{'cursor-grab': isAddingMode}"
                     ref="mapContentRef"
                     @touchstart="handleStart"
                     @touchmove="handleMove"
                     @touchend="handleEnd"
                     @mousedown="handleStart"
                     @mousemove="handleMove"
                     @mouseup="handleEnd"
                     @mouseleave="handleEnd">
                    
                    <!-- map.png -->
                    <img src="map.png" class="w-full h-auto block pointer-events-none" alt="Seoul Map">
                    
                    <!-- 分隔線 -->
                    <div class="w-full h-2 bg-gray-100/50"></div>

                    <!-- subway.png -->
                    <img src="subway.png" class="w-full h-auto block pointer-events-none" alt="Korea Subway Map">

                    <!-- Existing Pins -->
                    <!-- 修改：移除直接的 click 跳轉，改用 handlePinClick 處理單擊/雙擊 -->
                    <div v-for="spot in spots" :key="spot.id"
                         class="pin-marker animate-bounce-soft"
                         :class="[`pin-theme-${spot.theme}`]"
                         :style="{ top: spot.top, left: spot.left }"
                         @touchstart.stop
                         @mousedown.stop
                         @click.stop="handlePinClick(spot)">
                        <div class="pin-icon-box">
                            <img v-if="spot.images && spot.images.length > 0" :src="spot.images[0]" class="w-full h-full object-cover">
                            <i v-else class="fas text-lg" :class="{
                                'fa-utensils': spot.category === 'food',
                                'fa-shopping-bag': spot.category === 'shopping',
                                'fa-camera': spot.category === 'spot'
                            }"></i>
                        </div>
                        <div class="pin-tail"></div>
                        <div class="pin-label">{{ spot.name }}</div>
                    </div>

                    <!-- Ghost Pin (拖曳時顯示) -->
                    <div v-if="tempPin" 
                         class="pin-marker ghost-pin pin-theme-pink"
                         :style="{ top: tempPin.top, left: tempPin.left }">
                        <div class="pin-icon-box bg-white">
                            <i class="fas fa-map-marker-alt text-xl text-pink-500"></i>
                        </div>
                        <div class="pin-tail"></div>
                    </div>

                </div>

            </div>

        </div>

        <!-- 通用彈窗 (新增/編輯) -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-5" @click.self="cancelModal">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all">
                    
                    <!-- 標題：根據模式變化 -->
                    <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">
                        {{ isEditing ? '編輯地標' : '新增地標' }}
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-2">類別</label>
                            <div class="flex gap-2">
                                <button @click="quickForm.category = 'spot'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'spot' ? 'bg-pink-50 border-pink-200 text-pink-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-camera text-sm"></i> 景點</button>
                                <button @click="quickForm.category = 'food'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'food' ? 'bg-orange-50 border-orange-200 text-orange-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-utensils text-sm"></i> 餐廳</button>
                                <button @click="quickForm.category = 'shopping'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'shopping' ? 'bg-blue-50 border-blue-200 text-blue-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-shopping-bag text-sm"></i> 購物</button>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">名稱</label><input v-model="quickForm.name" type="text" placeholder="地點名稱" class="mt-1 w-full bg-gray-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-2">顏色</label>
                            <div class="flex justify-between gap-2">
                                <button v-for="color in ['pink', 'blue', 'green', 'yellow', 'purple']" :key="color" @click="quickForm.theme = color" class="w-8 h-8 rounded-full border-2 transition-transform active:scale-90" :class="[quickForm.theme === color ? 'border-gray-400 scale-110 shadow-sm' : 'border-transparent']" :style="{ backgroundColor: getColorCode(color) }"></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <!-- 刪除按鈕 (僅編輯模式顯示) -->
                        <button v-if="isEditing" @click="deleteSpot" class="w-12 py-3 rounded-xl font-bold text-white bg-red-500 shadow-lg shadow-red-200 text-sm flex items-center justify-center">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        
                        <button @click="cancelModal" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100 text-sm">取消</button>
                        <button @click="confirmAction" class="flex-1 py-3 rounded-xl font-bold text-white bg-pink-500 shadow-lg shadow-pink-200 text-sm" :disabled="!quickForm.name">
                            {{ isEditing ? '儲存' : '建立' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted } = Vue;
    createApp({
        setup() {
            const spots = ref([]);
            const isAddingMode = ref(false);
            const showModal = ref(false);
            const isEditing = ref(false); // 新增：是否為編輯模式
            const editingSpotId = ref(null); // 新增：正在編輯的 ID
            
            const tempPin = ref(null);
            const mapContentRef = ref(null);
            
            const quickForm = reactive({ name: '', theme: 'pink', category: 'spot' });

            // Panzoom 實例
            let panzoomInstance = null;
            
            // 拖曳邏輯變數
            let longPressTimer = null;
            let isDraggingPin = false;
            let startX = 0, startY = 0;
            const LONG_PRESS_DURATION = 200;
            const MOVE_THRESHOLD = 5;

            // 雙擊偵測變數
            let clickCount = 0;
            let clickTimer = null;

            // 初始化 Panzoom
            const initPanzoom = () => {
                const elem = document.getElementById('panzoom-area');
                if (!elem) return;
                if (panzoomInstance) panzoomInstance.destroy();

                panzoomInstance = Panzoom(elem, {
                    maxScale: 4, minScale: 1, startScale: 1, contain: 'outside', cursor: 'default', touchAction: 'none' 
                });

                if (elem.parentElement) {
                    elem.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
                }
            };

            onMounted(() => {
                const savedData = localStorage.getItem('seoul_travel_app_data');
                if (savedData) spots.value = JSON.parse(savedData);
                if (document.readyState === 'complete') initPanzoom();
                else window.addEventListener('load', initPanzoom);
                window.addEventListener('resize', () => setTimeout(initPanzoom, 100));
            });

            // --- 單擊 vs 雙擊 處理邏輯 ---
            const handlePinClick = (spot) => {
                if (isAddingMode.value) return; // 新增模式下不處理

                clickCount++;
                if (clickCount === 1) {
                    // 第一次點擊，設定計時器
                    clickTimer = setTimeout(() => {
                        // 時間到，確認為單擊 -> 跳轉
                        clickCount = 0;
                        window.location.href = `detail.html?id=${spot.id}`;
                    }, 250); // 250ms 延遲
                } else {
                    // 在時間內第二次點擊 -> 雙擊 -> 編輯
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    openEditModal(spot);
                }
            };

            const toggleAddMode = () => {
                isAddingMode.value = !isAddingMode.value;
                showModal.value = false;
                tempPin.value = null;
            };

            // --- 編輯 / 刪除 邏輯 ---
            const openEditModal = (spot) => {
                isEditing.value = true;
                editingSpotId.value = spot.id;
                // 填入現有資料
                quickForm.name = spot.name;
                quickForm.theme = spot.theme;
                quickForm.category = spot.category;
                showModal.value = true;
            };

            const deleteSpot = () => {
                if (!editingSpotId.value) return;
                if (confirm('確定要刪除這個地標嗎？')) {
                    spots.value = spots.value.filter(s => s.id !== editingSpotId.value);
                    localStorage.setItem('seoul_travel_app_data', JSON.stringify(spots.value));
                    showModal.value = false;
                }
            };

            // --- 長按拖曳新增邏輯 (保持不變) ---
            const getEventCoords = (e) => {
                if (e.touches && e.touches.length > 0) {
                    return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
                }
                return { clientX: e.clientX, clientY: e.clientY };
            };

            const calculateRelativeCoords = (clientX, clientY) => {
                const rect = mapContentRef.value.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                return {
                    left: (x / rect.width * 100).toFixed(2) + '%',
                    top: (y / rect.height * 100).toFixed(2) + '%',
                };
            };

            const handleStart = (e) => {
                if (!isAddingMode.value) return;
                const { clientX, clientY } = getEventCoords(e);
                startX = clientX; startY = clientY; isDraggingPin = false;

                longPressTimer = setTimeout(() => {
                    isDraggingPin = true;
                    if (navigator.vibrate) navigator.vibrate(50);
                    if (panzoomInstance) panzoomInstance.setOptions({ disablePan: true });
                    tempPin.value = calculateRelativeCoords(clientX, clientY);
                }, LONG_PRESS_DURATION);
            };

            const handleMove = (e) => {
                if (!isAddingMode.value) return;
                const { clientX, clientY } = getEventCoords(e);
                if (isDraggingPin) {
                    e.preventDefault(); e.stopPropagation();
                    tempPin.value = calculateRelativeCoords(clientX, clientY);
                } else {
                    if (Math.abs(clientX - startX) > MOVE_THRESHOLD || Math.abs(clientY - startY) > MOVE_THRESHOLD) {
                        clearTimeout(longPressTimer);
                    }
                }
            };

            const handleEnd = () => {
                clearTimeout(longPressTimer);
                if (isDraggingPin) {
                    isDraggingPin = false;
                    if (panzoomInstance) panzoomInstance.setOptions({ disablePan: false });
                    
                    // 開啟新增視窗
                    isEditing.value = false; // 確保不是編輯模式
                    editingSpotId.value = null;
                    quickForm.name = '';
                    quickForm.theme = 'pink';
                    quickForm.category = 'spot';
                    showModal.value = true;
                }
            };

            // --- 確認與取消 ---
            const confirmAction = () => {
                if (isEditing.value) {
                    // 編輯模式：更新現有地標
                    const spot = spots.value.find(s => s.id === editingSpotId.value);
                    if (spot) {
                        spot.name = quickForm.name;
                        spot.theme = quickForm.theme;
                        spot.category = quickForm.category;
                        // 不更新座標 (top/left)
                    }
                } else {
                    // 新增模式：建立新地標
                    if (!tempPin.value) return;
                    const newSpot = {
                        id: Date.now(),
                        name: quickForm.name,
                        theme: quickForm.theme,
                        category: quickForm.category,
                        top: tempPin.value.top,
                        left: tempPin.value.left,
                        date: new Date().toLocaleDateString(),
                        images: [],
                        description: '', hours: '', url: '', mapUrl: ''
                    };
                    spots.value.push(newSpot);
                }
                
                localStorage.setItem('seoul_travel_app_data', JSON.stringify(spots.value));
                showModal.value = false;
                isAddingMode.value = false;
                tempPin.value = null;
            };

            const cancelModal = () => { 
                showModal.value = false; 
                tempPin.value = null; 
            };
            
            const getColorCode = (n) => ({ pink: '#EC4899', blue: '#3B82F6', green: '#10B981', yellow: '#F59E0B', purple: '#8B5CF6' }[n]);

            return { 
                spots, isAddingMode, showModal, isEditing, quickForm, tempPin, mapContentRef,
                toggleAddMode, handleStart, handleMove, handleEnd, handlePinClick,
                confirmAction, cancelModal, deleteSpot, getColorCode 
            };
        }
    }).mount('#app');
</script>
</body>
</html>


