<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seoul Travel Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Panzoom Library (用於地圖縮放) -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #111; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .font-cute { font-family: 'Fredoka', 'Noto Sans TC', sans-serif; }
        
        /* App 容器 */
        #app-container { 
            max-width: 480px; 
            height: 100dvh; 
            margin: 0 auto; 
            background-color: #f3f4f6; 
            position: relative; 
            overflow: hidden; /* 隱藏原生滾動，改用 Panzoom */
            display: flex;
            flex-direction: column;
        }
        
        /* Pin Styles */
        .pin-marker { position: absolute; transform: translate(-50%, -100%); cursor: pointer; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        /* 縮放時保持 Pin 的互動感，但不讓它無限放大 (視需求可調整) */
        .pin-icon-box { width: 44px; height: 44px; background: white; border-radius: 50%; border: 3px solid white; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; }
        .pin-icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .pin-tail { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid white; margin-top: -2px; filter: drop-shadow(0 2px 1px rgba(0,0,0,0.1)); }
        .pin-label { background: rgba(255,255,255,0.95); padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; color: #4B5563; margin-top: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; }
        
        /* Theme Colors */
        .pin-theme-pink .pin-icon-box { border-color: #FCE7F3; background: #FCE7F3; color: #EC4899; } .pin-theme-pink .pin-tail { border-top-color: #FCE7F3; }
        .pin-theme-blue .pin-icon-box { border-color: #DBEAFE; background: #DBEAFE; color: #3B82F6; } .pin-theme-blue .pin-tail { border-top-color: #DBEAFE; }
        .pin-theme-green .pin-icon-box { border-color: #D1FAE5; background: #D1FAE5; color: #10B981; } .pin-theme-green .pin-tail { border-top-color: #D1FAE5; }
        .pin-theme-yellow .pin-icon-box { border-color: #FEF3C7; background: #FEF3C7; color: #F59E0B; } .pin-theme-yellow .pin-tail { border-top-color: #FEF3C7; }
        .pin-theme-purple .pin-icon-box { border-color: #EDE9FE; background: #EDE9FE; color: #8B5CF6; } .pin-theme-purple .pin-tail { border-top-color: #EDE9FE; }

        @keyframes bounce-soft { 0%, 100% { transform: translate(-50%, -100%); } 50% { transform: translate(-50%, -108%); } }
        .animate-bounce-soft { animation: bounce-soft 2s infinite ease-in-out; }
        
        .cursor-crosshair { cursor: crosshair !important; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.9); }
    </style>
</head>
<body>
<div id="app">
    <div id="app-container">
        
        <!-- UI Layer (固定在螢幕上，不隨地圖縮放) -->
        
        <!-- 新增按鈕 (左上角) -->
        <button class="fixed top-4 left-4 z-50 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transform transition-all duration-300"
                :class="isAddingMode ? 'bg-gray-800 text-white rotate-45 scale-110' : 'bg-white/90 backdrop-blur text-pink-500 hover:scale-105 active:scale-95'"
                :style="{ maxWidth: '480px' }" 
                @click.stop="toggleAddMode">
            <i class="fas fa-plus text-xl"></i>
        </button>

        <!-- 新增模式提示 -->
        <div v-if="isAddingMode" class="fixed top-5 left-20 z-50 bg-gray-800/90 backdrop-blur text-white px-4 py-1.5 rounded-full shadow-xl text-xs font-bold flex items-center gap-2 animate-bounce w-max pointer-events-none">
            <i class="fas fa-hand-pointer text-yellow-400"></i> <span>點擊地圖新增</span>
        </div>

        <!-- Map Layer (可縮放區域) -->
        <!-- 注意：overflow-hidden 很重要，因為縮放由 panzoom 控制 -->
        <div class="relative w-full h-full bg-gray-200 overflow-hidden" id="scene-container">
            
            <div id="panzoom-area" class="w-full flex flex-col origin-top-left bg-white min-h-full">
                
                <!-- 1. 首爾地圖區 (包含 Pins) -->
                <!-- Pins 必須包在這裡面，因為它們的座標是相對於 map.png 的 -->
                <div class="relative w-full" :class="{'cursor-crosshair': isAddingMode}" @click="handleMapClick">
                    <!-- map.png -->
                    <img src="map.png" class="w-full h-auto block" alt="Seoul Map">

                    <!-- Pins -->
                    <div v-for="spot in spots" :key="spot.id"
                         class="pin-marker animate-bounce-soft"
                         :class="[`pin-theme-${spot.theme}`]"
                         :style="{ top: spot.top, left: spot.left }"
                         @click.stop="goToDetail(spot.id)">
                        <div class="pin-icon-box">
                            <img v-if="spot.images && spot.images.length > 0" :src="spot.images[0]" class="w-full h-full object-cover">
                            <i v-else class="fas text-lg" :class="{
                                'fa-utensils': spot.category === 'food',
                                'fa-shopping-bag': spot.category === 'shopping',
                                'fa-camera': spot.category === 'spot'
                            }"></i>
                        </div>
                        <div class="pin-tail"></div>
                        <div class="pin-label">{{ spot.name }}</div>
                    </div>
                </div>

                <!-- 2. 韓國地鐵圖 (接在下方) -->
                <div class="w-full bg-white border-t-4 border-gray-100">
                    <!-- 請確保您的地鐵圖檔案命名為 subway.png -->
                    <img src="subway.png" class="w-full h-auto block" alt="Korea Subway Map">
                </div>

                <!-- 底部墊高一點，避免地鐵圖被邊緣切到 -->
                <div class="w-full h-20 bg-white"></div>
            </div>

        </div>

        <!-- 快速新增彈窗 -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-5" @click.self="cancelAdd">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">新增地標</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-2">類別</label>
                            <div class="flex gap-2">
                                <button @click="quickForm.category = 'spot'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'spot' ? 'bg-pink-50 border-pink-200 text-pink-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-camera text-sm"></i> 景點</button>
                                <button @click="quickForm.category = 'food'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'food' ? 'bg-orange-50 border-orange-200 text-orange-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-utensils text-sm"></i> 餐廳</button>
                                <button @click="quickForm.category = 'shopping'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-colors flex flex-col items-center justify-center gap-1" :class="quickForm.category === 'shopping' ? 'bg-blue-50 border-blue-200 text-blue-500' : 'border-gray-200 text-gray-400'"><i class="fas fa-shopping-bag text-sm"></i> 購物</button>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">名稱</label><input v-model="quickForm.name" type="text" placeholder="地點名稱" class="mt-1 w-full bg-gray-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-2">顏色</label>
                            <div class="flex justify-between gap-2">
                                <button v-for="color in ['pink', 'blue', 'green', 'yellow', 'purple']" :key="color" @click="quickForm.theme = color" class="w-8 h-8 rounded-full border-2 transition-transform active:scale-90" :class="[quickForm.theme === color ? 'border-gray-400 scale-110 shadow-sm' : 'border-transparent']" :style="{ backgroundColor: getColorCode(color) }"></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="cancelAdd" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100 text-sm">取消</button>
                        <button @click="confirmAdd" class="flex-1 py-3 rounded-xl font-bold text-white bg-pink-500 shadow-lg shadow-pink-200 text-sm" :disabled="!quickForm.name">建立</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted, nextTick } = Vue;
    createApp({
        setup() {
            const spots = ref([]);
            const isAddingMode = ref(false);
            const showModal = ref(false);
            const tempCoords = ref(null);
            
            const quickForm = reactive({ name: '', theme: 'pink', category: 'spot' });

            // Panzoom 實例
            let panzoomInstance = null;

            onMounted(() => {
                const savedData = localStorage.getItem('seoul_travel_app_data');
                if (savedData) spots.value = JSON.parse(savedData);

                // 初始化 Panzoom
                const elem = document.getElementById('panzoom-area');
                panzoomInstance = Panzoom(elem, {
                    maxScale: 4,      // 最大放大倍率
                    minScale: 1,      // 最小倍率 (不縮小)
                    startScale: 1,
                    contain: 'outside', // 限制邊界
                    cursor: 'default',
                    // 關鍵：這讓 click 事件能在拖曳結束時正常觸發，避免拖曳被誤判為點擊
                    handleStartEvent: (e) => {
                        e.preventDefault(); // 防止圖片拖曳的預設行為
                    }
                });

                // 支援滑鼠滾輪縮放
                elem.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
            });

            const toggleAddMode = () => {
                isAddingMode.value = !isAddingMode.value;
                if(!isAddingMode.value) {
                    showModal.value = false;
                    // 退出新增模式時，恢復 Panzoom
                    if(panzoomInstance) panzoomInstance.bind();
                } else {
                    // 進入新增模式時，暫時保留 Panzoom，因為使用者可能需要縮放來精準點擊
                    // 如果覺得操作衝突，可以在這裡 panzoomInstance.destroy() 暫停，但建議保留
                }
            };

            const handleMapClick = (e) => {
                if (!isAddingMode.value) return;
                
                // 計算邏輯：因為有縮放，必須使用 getBoundingClientRect
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // 計算相對百分比 (這在縮放後依然準確，因為 rect.width 是縮放後的寬度)
                const leftPercent = (x / rect.width * 100).toFixed(1) + '%';
                const topPercent = (y / rect.height * 100).toFixed(1) + '%';
                
                tempCoords.value = { top: topPercent, left: leftPercent };
                
                quickForm.name = '';
                quickForm.theme = 'pink';
                quickForm.category = 'spot';
                showModal.value = true;
            };

            const confirmAdd = () => {
                const newSpot = {
                    id: Date.now(),
                    name: quickForm.name,
                    theme: quickForm.theme,
                    category: quickForm.category,
                    top: tempCoords.value.top,
                    left: tempCoords.value.left,
                    date: new Date().toLocaleDateString(),
                    images: [],
                    description: '', hours: '', url: '', mapUrl: ''
                };
                
                spots.value.push(newSpot);
                localStorage.setItem('seoul_travel_app_data', JSON.stringify(spots.value));
                
                showModal.value = false;
                isAddingMode.value = false;
            };

            const cancelAdd = () => { showModal.value = false; tempCoords.value = null; };
            const goToDetail = (id) => {
                // 防止拖曳時觸發點擊 (Panzoom 的 click 事件處理有時比較敏感)
                // 這裡簡單處理：直接跳轉
                window.location.href = `detail.html?id=${id}`;
            };
            
            const getColorCode = (n) => ({ pink: '#EC4899', blue: '#3B82F6', green: '#10B981', yellow: '#F59E0B', purple: '#8B5CF6' }[n]);

            return { spots, isAddingMode, showModal, quickForm, toggleAddMode, handleMapClick, confirmAdd, cancelAdd, goToDetail, getColorCode };
        }
    }).mount('#app');
</script>
</body>
</html>


